---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

# Notepad

## Introduction

I'm starting to run through the process of predicting the midterms. I'd like to use this markdown doc as a notepad to catalogue my process & thoughts as I work on this project. This will be rambling long form format with pretty much *no* editing, so forgive me for anything that may be confusing. I'll use this as a working document before transferring code over to scripts. 

```{r}
library(tidyverse)
```

## Demographic Data

I'll start by getting demographic data into the environment. I want it in a tidy format, but the census bureau data is pretty unwieldy, so it'll need to be wrangled before being useful. 

I want to get a handle on wrangling the data, so I'll only load in one decade of census bureau data, and only focus on one state for now.

```{r}
# read in census bureau data
f_cb2010_2019 <- read_csv("https://www2.census.gov/programs-surveys/popest/tables/2010-2019/state/asrh/sc-est2019-alldata5.csv")

# initial wrangling
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010)

```

I want to have year be a variable as well, so I'll reformat the table to collect these into a column, year, and put all the values into a new column, pop. I'll also do some quality-of-life column renaming

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE)
```

Now the fun gets to start - I want the following demographic variables as their own columns: 
* **pct_male : ** percentage of population that is male.
* **pct_hispanic : ** percentage of population that is hispanic. While the census data is there, I don't plan on breaking this down by hispanic race.
* **pct_white : ** percentage of population that is non-hispanic white.
* **pct_black : ** percentage of population that is non-hispanic black. 
* **pct_nat_american : ** percentage of population that is non-hispanic native american.
* **pct_asian : ** percentage of population that is non-hispanic asian.
* **pct_pac_island : ** percentage of population that is non-hispanic pacific-islander.

Source for category codes can be found [here](https://www2.census.gov/programs-surveys/popest/technical-documentation/file-layouts/2010-2019/sc-est2019-alldata6.pdf)

Firstly, let's check for population totals/errors.

I'll start by putting gender into columns, and summing the totals to verify that each year adds up correctly. The genders are denoted by a numeric indicator, so I'll change the column titles to strings for clarity.

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(total = "0",
         male = "1",
         female = "2")
```

Firstly, I need to check that the male + female columns equal the total column for each row.

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(total = "0",
         male = "1",
         female = "2") %>%
  mutate(check = total - male - female) %>%
  distinct(check, .keep_all = TRUE)
```

Okay, this verifies that all the rows add up correctly. Now I'll get a quick check frame with the totals from each year

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(total = "0",
         male = "1",
         female = "2") %>%
  group_by(year) %>%
  mutate(pop_year = sum(total)) %>%
  arrange(year)
```

Ah okay, I just realized something. The "total" rows (0s in sex/origin) are throwing things off quite a bit (essentially doubling total population). I need to filter these out first.

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  filter(sex != 0,
         origin != 0)
```

Now I'll create the totals frame for checking.

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  filter(sex != 0,
         origin != 0) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(male = "1",
         female = "2") %>%
  mutate(total = male + female) %>%
  group_by(year) %>%
  mutate(total_yr = sum(total)) %>%
  arrange(year) %>%
  distinct(total_yr, .keep_all = TRUE) %>%
  select(state, year, total_yr)
```

This frame will be what I use to check that the population totals for other categories add up correctly. 

Now to calculate the pct_male for each year

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  filter(sex != 0,
         origin != 0) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(male = "1",
         female = "2") %>%
  group_by(year) %>%
  mutate(tot_male = sum(male),
         tot_female = sum(female)) %>%
  ungroup() %>%
  mutate(tot_pop = tot_male + tot_female,
         pct_male = tot_male/tot_pop) %>%
  select(-tot_male, -tot_female, -tot_pop) %>%
  mutate(tot_row = male + female) %>%
  select(-male, -female) %>%
  relocate(tot_row, .after = year) %>%
  arrange(year)
```

Cool, one down, several to go. The tot_row column now shows the total (male and female) population for each row, given the origin (hispanic/non-hispanic), race, and age categories. 

I can repeate a similar process for the hispanic/non-hispanic qualifiers, but first I need to verify that the population totals add up. 

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  filter(sex != 0,
         origin != 0) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(male = "1",
         female = "2") %>%
  group_by(year) %>%
  mutate(tot_male = sum(male),
         tot_female = sum(female)) %>%
  ungroup() %>%
  mutate(tot_pop = tot_male + tot_female,
         pct_male = tot_male/tot_pop) %>%
  select(-tot_male, -tot_female, -tot_pop) %>%
  mutate(tot_row = male + female) %>%
  select(-male, -female) %>%
  relocate(tot_row, .after = year) %>%
  arrange(year) %>%
  pivot_wider(names_from = origin,
              values_from = tot_row) %>%
  rename(non_hispanic = "1",
         hispanic = "2") %>%
  mutate(tot_row = non_hispanic + hispanic) %>%
  group_by(year) %>%
  mutate(check = sum(tot_row)) %>%
  ungroup() %>%
  distinct(year, .keep_all = TRUE) %>%
  select(state, year, check)
```

Coolio, checks out. I'm going to pivot a bit and do all the races at once, rather than the one-two step between hispanic/nonhipanic then all other races. I'll write over the race column with a "6" for hispanic where applicable. 

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  filter(sex != 0,
         origin != 0) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(male = "1",
         female = "2") %>%
  group_by(year) %>%
  mutate(tot_male = sum(male),
         tot_female = sum(female)) %>%
  ungroup() %>%
  mutate(tot_pop = tot_male + tot_female,
         pct_male = tot_male/tot_pop) %>%
  select(-tot_male, -tot_female, -tot_pop) %>%
  mutate(tot_row = male + female) %>%
  select(-male, -female) %>%
  relocate(tot_row, .after = year) %>%
  arrange(year) %>%
  mutate(race = if_else(origin == 1, race, 6)) %>%
  select(-origin)
```

With that cleaned up, I can repeat the steps taken to get the pct_male population for each race. Firstly, I'll rearrange the data frame & check the population totals.

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  filter(sex != 0,
         origin != 0) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(male = "1",
         female = "2") %>%
  group_by(year) %>%
  mutate(tot_male = sum(male),
         tot_female = sum(female)) %>%
  ungroup() %>%
  mutate(tot_pop = tot_male + tot_female,
         pct_male = tot_male/tot_pop) %>%
  select(-tot_male, -tot_female, -tot_pop) %>%
  mutate(tot_row = male + female) %>%
  select(-male, -female) %>%
  relocate(tot_row, .after = year) %>%
  arrange(year) %>%
  mutate(race = if_else(origin == 1, race, 6)) %>%
  select(-origin) %>%
  group_by(race, age, year) %>%
  mutate(tot_row = sum(tot_row)) %>%
  distinct(tot_row, .keep_all = TRUE) %>%
  ungroup(race, age, year) %>%
  pivot_wider(names_from = race,
              values_from = tot_row) %>%
  rename(white = "1",
         black = "2",
         nat_american = "3",
         asian = "4",
         pac_island = "5",
         hispanic = "6") %>%
  mutate(tot_row = white + black + nat_american + asian + pac_island + hispanic) %>%
  group_by(year) %>%
  mutate(check = sum(tot_row)) %>%
  ungroup() %>%
  distinct(year, .keep_all = TRUE) %>%
  select(state, year, check)
```

Awesome, everything here checks out! I was getting something weird last night wehre there was a bit of double counting - I think that it was because hispanic/non-hispanic is its own category. 

Now here's the percentages for each race:

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  filter(sex != 0,
         origin != 0) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(male = "1",
         female = "2") %>%
  group_by(year) %>%
  mutate(tot_male = sum(male),
         tot_female = sum(female)) %>%
  ungroup() %>%
  mutate(tot_pop = tot_male + tot_female,
         pct_male = tot_male/tot_pop) %>%
  select(-tot_male, -tot_female, -tot_pop) %>%
  mutate(tot_row = male + female) %>%
  select(-male, -female) %>%
  relocate(tot_row, .after = year) %>%
  arrange(year) %>%
  mutate(race = if_else(origin == 1, race, 6)) %>%
  select(-origin) %>%
  group_by(race, age, year) %>%
  mutate(tot_row = sum(tot_row)) %>%
  distinct(tot_row, .keep_all = TRUE) %>%
  ungroup(race, age, year) %>%
  pivot_wider(names_from = race,
              values_from = tot_row) %>%
  rename(white = "1",
         black = "2",
         nat_american = "3",
         asian = "4",
         pac_island = "5",
         hispanic = "6") %>%
  mutate(tot_row = white + black + nat_american + asian + pac_island + hispanic) %>%
  group_by(year) %>%
  mutate(pct_white = sum(white)/sum(tot_row),
         pct_black = sum(black)/sum(tot_row), 
         pct_nat_american = sum(nat_american)/sum(tot_row),
         pct_asian = sum(asian)/sum(tot_row),
         pct_pac_island = sum(pac_island)/sum(tot_row),
         pct_hispanic = sum(hispanic)/sum(tot_row),
         check = pct_white + pct_black + pct_nat_american + pct_asian + pct_pac_island + pct_hispanic) %>%
  distinct(check, .keep_all = TRUE)
```

I did a quick check of the totals to ensure they add to one (they do). With that (finally) checked, I can clean this up and start to look at age.

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  filter(sex != 0,
         origin != 0) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(male = "1",
         female = "2") %>%
  group_by(year) %>%
  mutate(tot_male = sum(male),
         tot_female = sum(female)) %>%
  ungroup() %>%
  mutate(tot_pop = tot_male + tot_female,
         pct_male = tot_male/tot_pop) %>%
  select(-tot_male, -tot_female, -tot_pop) %>%
  mutate(tot_row = male + female) %>%
  select(-male, -female) %>%
  relocate(tot_row, .after = year) %>%
  arrange(year) %>%
  mutate(race = if_else(origin == 1, race, 6)) %>%
  select(-origin) %>%
  group_by(race, age, year) %>%
  mutate(tot_row = sum(tot_row)) %>%
  distinct(tot_row, .keep_all = TRUE) %>%
  ungroup(race, age, year) %>%
  pivot_wider(names_from = race,
              values_from = tot_row) %>%
  rename(white = "1",
         black = "2",
         nat_american = "3",
         asian = "4",
         pac_island = "5",
         hispanic = "6") %>%
  mutate(tot_row = white + black + nat_american + asian + pac_island + hispanic) %>%
  group_by(year) %>%
  mutate(pct_white = sum(white)/sum(tot_row),
         pct_black = sum(black)/sum(tot_row), 
         pct_nat_american = sum(nat_american)/sum(tot_row),
         pct_asian = sum(asian)/sum(tot_row),
         pct_pac_island = sum(pac_island)/sum(tot_row),
         pct_hispanic = sum(hispanic)/sum(tot_row)) %>%
  select(-white, -black, -nat_american, -asian, -pac_island, -hispanic)
```

Hmm. I'm noticing that the `pct_pac_island` is pretty small (and I imagine this will be the case for pretty much everywhere but Hawaii). I'll merge this with `pct_asian` to a new col, `pct_aapi` (Asian American/Pacific Islander). 

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  filter(sex != 0,
         origin != 0) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(male = "1",
         female = "2") %>%
  group_by(year) %>%
  mutate(tot_male = sum(male),
         tot_female = sum(female)) %>%
  ungroup() %>%
  mutate(tot_pop = tot_male + tot_female,
         pct_male = tot_male/tot_pop) %>%
  select(-tot_male, -tot_female, -tot_pop) %>%
  mutate(tot_row = male + female) %>%
  select(-male, -female) %>%
  relocate(tot_row, .after = year) %>%
  arrange(year) %>%
  mutate(race = if_else(origin == 1, race, 6)) %>%
  select(-origin) %>%
  group_by(race, age, year) %>%
  mutate(tot_row = sum(tot_row)) %>%
  distinct(tot_row, .keep_all = TRUE) %>%
  ungroup(race, age, year) %>%
  pivot_wider(names_from = race,
              values_from = tot_row) %>%
  rename(white = "1",
         black = "2",
         nat_american = "3",
         asian = "4",
         pac_island = "5",
         hispanic = "6") %>%
  mutate(tot_row = white + black + nat_american + asian + pac_island + hispanic) %>%
  group_by(year) %>%
  mutate(pct_white = sum(white)/sum(tot_row),
         pct_black = sum(black)/sum(tot_row), 
         pct_nat_american = sum(nat_american)/sum(tot_row),
         pct_asian = sum(asian)/sum(tot_row),
         pct_pac_island = sum(pac_island)/sum(tot_row),
         pct_hispanic = sum(hispanic)/sum(tot_row)) %>%
  ungroup() %>%
  select(-white, -black, -nat_american, -asian, -pac_island, -hispanic) %>%
  mutate(pct_aapi = pct_asian + pct_pac_island) %>%
  select(-pct_asian, -pct_pac_island)
```

Coolio jones. Now I need to figure out a way to get the population percentage for age groups. I'm thinking of utilizing the following groups:
* Under 18 (up to and including 17)
* 18 - 34
* 35 - 64
* 65 + 

I also want to get the mean age (and maybe mean age of 18+), which I think will be *slightly* easier, so let's start with that.

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  filter(sex != 0,
         origin != 0) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(male = "1",
         female = "2") %>%
  group_by(year) %>%
  mutate(tot_male = sum(male),
         tot_female = sum(female)) %>%
  ungroup() %>%
  mutate(tot_pop = tot_male + tot_female,
         pct_male = tot_male/tot_pop) %>%
  select(-tot_male, -tot_female, -tot_pop) %>%
  mutate(tot_row = male + female) %>%
  select(-male, -female) %>%
  relocate(tot_row, .after = year) %>%
  arrange(year) %>%
  mutate(race = if_else(origin == 1, race, 6)) %>%
  select(-origin) %>%
  group_by(race, age, year) %>%
  mutate(tot_row = sum(tot_row)) %>%
  distinct(tot_row, .keep_all = TRUE) %>%
  ungroup(race, age, year) %>%
  pivot_wider(names_from = race,
              values_from = tot_row) %>%
  rename(white = "1",
         black = "2",
         nat_american = "3",
         asian = "4",
         pac_island = "5",
         hispanic = "6") %>%
  mutate(tot_row = white + black + nat_american + asian + pac_island + hispanic) %>%
  group_by(year) %>%
  mutate(pct_white = sum(white)/sum(tot_row),
         pct_black = sum(black)/sum(tot_row), 
         pct_nat_american = sum(nat_american)/sum(tot_row),
         pct_asian = sum(asian)/sum(tot_row),
         pct_pac_island = sum(pac_island)/sum(tot_row),
         pct_hispanic = sum(hispanic)/sum(tot_row)) %>%
  ungroup() %>%
  select(-white, -black, -nat_american, -asian, -pac_island, -hispanic) %>%
  mutate(pct_aapi = pct_asian + pct_pac_island) %>%
  select(-pct_asian, -pct_pac_island) %>%
  mutate(age_score = age * tot_row) %>%
  group_by(year) %>%
  mutate(avg_age = sum(age_score)/sum(tot_row)) %>%
  distinct(year, .keep_all = TRUE) %>%
  select(state, year, avg_age)
```

I think I did that right, but let me do a quick sanity check w/a histogram for 2010 just to be sure.

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  filter(sex != 0,
         origin != 0) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(male = "1",
         female = "2") %>%
  group_by(year) %>%
  mutate(tot_male = sum(male),
         tot_female = sum(female)) %>%
  ungroup() %>%
  mutate(tot_pop = tot_male + tot_female,
         pct_male = tot_male/tot_pop) %>%
  select(-tot_male, -tot_female, -tot_pop) %>%
  mutate(tot_row = male + female) %>%
  select(-male, -female) %>%
  relocate(tot_row, .after = year) %>%
  arrange(year) %>%
  mutate(race = if_else(origin == 1, race, 6)) %>%
  select(-origin) %>%
  group_by(race, age, year) %>%
  mutate(tot_row = sum(tot_row)) %>%
  distinct(tot_row, .keep_all = TRUE) %>%
  ungroup(race, age, year) %>%
  pivot_wider(names_from = race,
              values_from = tot_row) %>%
  rename(white = "1",
         black = "2",
         nat_american = "3",
         asian = "4",
         pac_island = "5",
         hispanic = "6") %>%
  mutate(tot_row = white + black + nat_american + asian + pac_island + hispanic) %>%
  group_by(year) %>%
  mutate(pct_white = sum(white)/sum(tot_row),
         pct_black = sum(black)/sum(tot_row), 
         pct_nat_american = sum(nat_american)/sum(tot_row),
         pct_asian = sum(asian)/sum(tot_row),
         pct_pac_island = sum(pac_island)/sum(tot_row),
         pct_hispanic = sum(hispanic)/sum(tot_row)) %>%
  ungroup() %>%
  select(-white, -black, -nat_american, -asian, -pac_island, -hispanic) %>%
  mutate(pct_aapi = pct_asian + pct_pac_island) %>%
  select(-pct_asian, -pct_pac_island) %>%
  select(age, year, tot_row) %>%
  filter(year == "2010") %>%
  ggplot(aes(x = age,
             y = tot_row)) +
  geom_col()
```

Okay, I suppose that would check out. I'll note that the census bins everyone *over* the age of 85 into one category, 85+, so this may be *slightly* off, but considering that the population drops off considerably at this age bracket, I'm okay with just treating it as 85 years old. 

Now I got to figure out the mean age 18+, which may be a bit harder.

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  filter(sex != 0,
         origin != 0) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(male = "1",
         female = "2") %>%
  group_by(year) %>%
  mutate(tot_male = sum(male),
         tot_female = sum(female)) %>%
  ungroup() %>%
  mutate(tot_pop = tot_male + tot_female,
         pct_male = tot_male/tot_pop) %>%
  select(-tot_male, -tot_female, -tot_pop) %>%
  mutate(tot_row = male + female) %>%
  select(-male, -female) %>%
  relocate(tot_row, .after = year) %>%
  arrange(year) %>%
  mutate(race = if_else(origin == 1, race, 6)) %>%
  select(-origin) %>%
  group_by(race, age, year) %>%
  mutate(tot_row = sum(tot_row)) %>%
  distinct(tot_row, .keep_all = TRUE) %>%
  ungroup(race, age, year) %>%
  pivot_wider(names_from = race,
              values_from = tot_row) %>%
  rename(white = "1",
         black = "2",
         nat_american = "3",
         asian = "4",
         pac_island = "5",
         hispanic = "6") %>%
  mutate(tot_row = white + black + nat_american + asian + pac_island + hispanic) %>%
  group_by(year) %>%
  mutate(pct_white = sum(white)/sum(tot_row),
         pct_black = sum(black)/sum(tot_row), 
         pct_nat_american = sum(nat_american)/sum(tot_row),
         pct_asian = sum(asian)/sum(tot_row),
         pct_pac_island = sum(pac_island)/sum(tot_row),
         pct_hispanic = sum(hispanic)/sum(tot_row)) %>%
  ungroup() %>%
  select(-white, -black, -nat_american, -asian, -pac_island, -hispanic) %>%
  mutate(pct_aapi = pct_asian + pct_pac_island) %>%
  select(-pct_asian, -pct_pac_island) %>%
  mutate(age_score = age * tot_row) %>%
  group_by(year) %>%
  mutate(avg_age = sum(age_score)/sum(tot_row)) %>%
  ungroup() %>%
  mutate(age_score = if_else(age < 18, 0, age * tot_row),
         age_total = if_else(age < 18, 0, tot_row)) %>%
  group_by(year) %>%
  mutate(avg_age_adult = sum(age_score)/sum(age_total)) %>%
  ungroup() %>%
  distinct(year, .keep_all = TRUE) %>%
  select(year, avg_age, avg_age_adult)
```

Dope dope, with `avg_age` and `avg_age_adult` done, I can move on to the age groups. 

```{r}
f_cb2010_2019 %>%
  filter(NAME == "Alabama") %>%
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>%
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  filter(sex != 0,
         origin != 0) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(male = "1",
         female = "2") %>%
  group_by(year) %>%
  mutate(tot_male = sum(male),
         tot_female = sum(female)) %>%
  ungroup() %>%
  mutate(tot_pop = tot_male + tot_female,
         pct_male = tot_male/tot_pop) %>%
  select(-tot_male, -tot_female, -tot_pop) %>%
  mutate(tot_row = male + female) %>%
  select(-male, -female) %>%
  relocate(tot_row, .after = year) %>%
  arrange(year) %>%
  mutate(race = if_else(origin == 1, race, 6)) %>%
  select(-origin) %>%
  group_by(race, age, year) %>%
  mutate(tot_row = sum(tot_row)) %>%
  distinct(tot_row, .keep_all = TRUE) %>%
  ungroup(race, age, year) %>%
  pivot_wider(names_from = race,
              values_from = tot_row) %>%
  rename(white = "1",
         black = "2",
         nat_american = "3",
         asian = "4",
         pac_island = "5",
         hispanic = "6") %>%
  mutate(tot_row = white + black + nat_american + asian + pac_island + hispanic) %>%
  group_by(year) %>%
  mutate(pct_white = sum(white)/sum(tot_row),
         pct_black = sum(black)/sum(tot_row), 
         pct_nat_american = sum(nat_american)/sum(tot_row),
         pct_asian = sum(asian)/sum(tot_row),
         pct_pac_island = sum(pac_island)/sum(tot_row),
         pct_hispanic = sum(hispanic)/sum(tot_row)) %>%
  ungroup() %>%
  select(-white, -black, -nat_american, -asian, -pac_island, -hispanic) %>%
  mutate(pct_aapi = pct_asian + pct_pac_island) %>%
  select(-pct_asian, -pct_pac_island) %>%
  mutate(age_score = age * tot_row) %>%
  group_by(year) %>%
  mutate(avg_age = sum(age_score)/sum(tot_row)) %>%
  ungroup() %>%
  mutate(age_score = if_else(age < 18, 0, age * tot_row),
         age_total = if_else(age < 18, 0, tot_row)) %>%
  group_by(year) %>%
  mutate(avg_age_adult = sum(age_score)/sum(age_total)) %>%
  ungroup() %>%
  select(-age_score, -age_total) %>%
  mutate(age_00_17 = if_else(age < 18, tot_row, 0),
         age_18_34 = if_else(age >= 18 & age < 35, tot_row, 0),
         age_35_64 = if_else(age >= 35 & age < 65, tot_row, 0),
         age_65_00 = if_else(age >= 65, tot_row, 0)) %>%
  group_by(year) %>%
  mutate(pct_00_17 = sum(age_00_17)/sum(tot_row),
         pct_18_34 = sum(age_18_34)/sum(tot_row),
         pct_35_64 = sum(age_35_64)/sum(tot_row),
         pct_65_00 = sum(age_65_00)/sum(tot_row),
         pop = sum(tot_row)) %>%
  ungroup() %>%
  distinct(year, .keep_all = TRUE) %>%
  select(-age_00_17, -age_18_34, -age_35_64, -age_65_00, -age, -tot_row) %>%
  relocate(pop, .after = year)
```

And with that, a 197,370 row by 21 col data frame was reduced to a much more useful 10 row by 16 col frame. Now I'll need to extend this out to the other states for this decade, then wrangle in other decades worth of census bureau data (hopefully using the exact same process).

I'll start with just this initial import, & see if there's anything funky going on. I expect this to run pretty smoothly, since it's formatted the same for each state/district, but it's always good to double check. Let's see what states/districts we're working with.

```{r}
f_cb2010_2019 %>%
  distinct(NAME, .keep_all = TRUE) %>%
  select(STATE, NAME)

f_cb2010_2019 %>%
  distinct(STATE, .keep_all = TRUE) %>%
  select(STATE, NAME)
```

Okay, so it looks like all the states plus DC are represented, but there's no US category. That's okay, I'm not sure if a US category is needed. I'll need to add `name` to any `group_by` call, but other than that, I think I can leave the code as-is. Let's see...

```{r}
f_cb2010_2019 %>% 
  select(-SUMLEV, -REGION, -DIVISION, -STATE, -CENSUS2010POP, -ESTIMATESBASE2010) %>% 
  pivot_longer(cols = starts_with("POPESTIMATE"),
               names_to = "year",
               names_prefix = "POPESTIMATE",
               values_to = "pop") %>%
  rename(state = NAME,
         sex = SEX,
         origin = ORIGIN,
         race = RACE,
         age = AGE) %>%
  filter(sex != 0,
         origin != 0) %>%
  pivot_wider(names_from = sex,
              values_from = pop) %>%
  rename(male = "1",
         female = "2") %>%
  group_by(state, year) %>%
  mutate(tot_male = sum(male),
         tot_female = sum(female)) %>%
  ungroup(state, year) %>%
  mutate(tot_pop = tot_male + tot_female,
         pct_male = tot_male/tot_pop) %>%
  select(-tot_male, -tot_female, -tot_pop) %>%
  mutate(tot_row = male + female) %>%
  select(-male, -female) %>%
  relocate(tot_row, .after = year) %>%
  arrange(year) %>%
  mutate(race = if_else(origin == 1, race, 6)) %>%
  select(-origin) %>%
  group_by(state, race, age, year) %>%
  mutate(tot_row = sum(tot_row)) %>%
  distinct(tot_row, .keep_all = TRUE) %>%
  ungroup(state, race, age, year) %>%
  pivot_wider(names_from = race,
              values_from = tot_row) %>%
  rename(white = "1",
         black = "2",
         nat_american = "3",
         asian = "4",
         pac_island = "5",
         hispanic = "6") %>%
  mutate(tot_row = white + black + nat_american + asian + pac_island + hispanic) %>%
  group_by(state, year) %>%
  mutate(pct_white = sum(white)/sum(tot_row),
         pct_black = sum(black)/sum(tot_row), 
         pct_nat_american = sum(nat_american)/sum(tot_row),
         pct_asian = sum(asian)/sum(tot_row),
         pct_pac_island = sum(pac_island)/sum(tot_row),
         pct_hispanic = sum(hispanic)/sum(tot_row)) %>%
  ungroup(state, year) %>%
  select(-white, -black, -nat_american, -asian, -pac_island, -hispanic) %>%
  mutate(pct_aapi = pct_asian + pct_pac_island) %>%
  select(-pct_asian, -pct_pac_island) %>%
  mutate(age_score = age * tot_row) %>%
  group_by(state, year) %>%
  mutate(avg_age = sum(age_score)/sum(tot_row)) %>%
  ungroup(state, year) %>%
  mutate(age_score = if_else(age < 18, 0, age * tot_row),
         age_total = if_else(age < 18, 0, tot_row)) %>%
  group_by(state, year) %>%
  mutate(avg_age_adult = sum(age_score)/sum(age_total)) %>%
  ungroup(state, year) %>%
  select(-age_score, -age_total) %>%
  mutate(age_00_17 = if_else(age < 18, tot_row, 0),
         age_18_34 = if_else(age >= 18 & age < 35, tot_row, 0),
         age_35_64 = if_else(age >= 35 & age < 65, tot_row, 0),
         age_65_00 = if_else(age >= 65, tot_row, 0)) %>%
  group_by(state, year) %>%
  mutate(pct_00_17 = sum(age_00_17)/sum(tot_row),
         pct_18_34 = sum(age_18_34)/sum(tot_row),
         pct_35_64 = sum(age_35_64)/sum(tot_row),
         pct_65_00 = sum(age_65_00)/sum(tot_row),
         pop = sum(tot_row)) %>%
  ungroup(state, year) %>%
  group_by(state) %>%
  distinct(year, .keep_all = TRUE) %>%
  ungroup() %>%
  select(-age_00_17, -age_18_34, -age_35_64, -age_65_00, -age, -tot_row) %>%
  relocate(pop, .after = year)
```

Coolio bo-boolio. Now the bigger test of checking that the other decades on the census bureau's site don't have any data formatting issues. 

```{r}
f_cb2000_2009 <- read_csv("https://www2.census.gov/programs-surveys/popest/datasets/2000-2009/state/asrh/sc-est2009-alldata5-all.csv")

f_cb2000_2009
```

Okay so that looks like that is formatted consistently, now I need to double check the 90's and the 80's (that's all the census data that exists online):

```{r}
fwf_empty(file = "C:/Users/z003ynch/Desktop/Personal/site_projects/thedatadiary_repo/electionsimulator/data/raw/comp8090.txt")
```

Sucks... Took me a bit to get this even read (and not sure that it's done correctly?)

```{r}
# read_fwf(file = "C:/Users/z003ynch/Desktop/Personal/site_projects/thedatadiary_repo/electionsimulator/data/raw/comp8090.txt",
#          col_positions = fwf_width(c(1, 5, 31, 7, 31, 7, 23, 7, 7, 7, 7, 7)))
```

Okay so this is getting a bit tedious. I need to find something in a better format...

Scratch that briefly, Here's some important ish tables that I found on the census bureau website. [This](https://www2.census.gov/programs-surveys/decennial/tables/time-series/historical-income-states/state1.csv) is a median household income by state dataset from 1969-1999 (evaluated each decade). I can extract the years inbetween using this dataset, though I need to get something more complete overall. [This](https://www2.census.gov/programs-surveys/cps/tables/time-series/historical-income-households/h08.xlsx) covers the remaining years in the 2000s.

Also just in general, [this interactive table](https://data.census.gov/cedsci/table?q=educational%20attainment&g=0100000US,.04000.001_0400000US72&tid=ACSST1Y2018.S1501&tp=true&hidePreview=true) is super helpful, helps drill down to what is needed with relative ease, though the .csv output is pretty jank. Something to look into if there's not a lot of great pre-formatted options...

Okay [here's](https://www2.census.gov/programs-surveys/demo/tables/educational-attainment/time-series/educational-attainment-1940-2000/table6a.xls) the percentage of the population 25 years or older with a bachelor's degree or higher, evaluated on the decade up to 2000. 

As a side bar - it looks like a lot of these will need some light reformatting prior to loading into my environment (census bureau likes to use excel as a word processor). 

I'm looking for something that gives the religious affiliation (or even just religiosity) by state by year and I'm not really finding any annualized datasets. I might just start digging into the above datasets just to keep being productive. 

[This](https://www.census.gov/data/datasets/time-series/demo/popest/intercensal-1990-2000-state-and-county-characteristics.html) gives state/county info each year for age group, race-sex, and ethnic origin. The file structure is weird (fwf) but I may just be able to manually drag/drop into a .csv. Let's try reading it in first.

```{r}
read_fwf("https://www2.census.gov/programs-surveys/popest/tables/1990-2000/intercensal/st-co/stch-icen1990.txt",
         fwf_empty("https://www2.census.gov/programs-surveys/popest/tables/1990-2000/intercensal/st-co/stch-icen1990.txt",
                   col_names = c("year", "state-county_FIPS", "age_group", "race-sex", "origin", "pop")))
```

Holy moley it worked!! Okay, now I have to do a lot of transformations similar to what was done above, then repeat for each of the years 91-99. Maybe I'll try my hand at writing a function for this.

```{r}
f_cb1990 <- read_fwf("https://www2.census.gov/programs-surveys/popest/tables/1990-2000/intercensal/st-co/stch-icen1990.txt",
                     fwf_empty("https://www2.census.gov/programs-surveys/popest/tables/1990-2000/intercensal/st-co/stch-icen1990.txt",
                               col_names = c("year", "state-county_FIPS", "age_group", "race-sex", "origin", "pop")))

f_cb1990

```

The first thing to do is to summarize all this into state info. The state-county_FIPS gives the county names, so I'll just need to do a quick `left_join` to get these to states. I'm pulling the FIPS codes from [this USDA site](https://www.nrcs.usda.gov/wps/portal/nrcs/detail/national/home/?cid=nrcs143_013697)

```{r}
f_fips <- read_csv("C:/Users/z003ynch/Desktop/Personal/site_projects/thedatadiary_repo/electionsimulator/data/raw/county_FIPS.csv")

# add 0 to FIPS code to make left_join work
f_fips <- f_fips %>%
  mutate(FIPS = if_else(FIPS < 10000, 
                        paste("0", as.character(FIPS), sep = ""),
                        as.character(FIPS)))

f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State) %>%
  mutate(year = as.character(year))
```

Excelente. With that edited, now I need to summarize each row by state; let me ckeck that each of demographic groups is getting counted multiple times (aka, once per county). 

```{r}
# f_cb1990 %>%
#   left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
#   select(-`state-county_FIPS`, -Name) %>%
#   relocate(State, .after = year) %>%
#   rename(state = State) %>%
#   mutate(year = as.character(year)) %>%
#   filter(state == "AL",
#          age_group == 1,
#          race-sex == 1,
#          origin == 1)
```

Okay it didn't like that I need to rename one of the columns to be more workable.

```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  filter(state == "AL",
         age_group == 1,
         race_sex == 1,
         origin == 1)
```

And yeah, that confirms it. Now to condense this frame a bit.

```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  group_by(state, age_group, race_sex, origin) %>%
  mutate(pop = sum(pop)) %>%
  ungroup(state, age_group, race_sex, origin) %>%
  mutate(identity = paste(state, age_group, race_sex, origin, sep = "-")) %>%
  distinct(identity, .keep_all = TRUE)
  
```

I had to add an `identity` column to be able to get rid of all the county variables. I left it above for viewership sake, but will remove it shortly. Now I can start getting into the meat of the demographics calculations.

```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  group_by(state, age_group, race_sex, origin) %>%
  mutate(pop = sum(pop)) %>%
  ungroup(state, age_group, race_sex, origin) %>%
  mutate(identity = paste(state, age_group, race_sex, origin, sep = "-")) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity) %>%
  pivot_wider(names_from = race_sex,
              values_from = pop) %>%
  rename(white_male = "1",
         white_female = "2",
         black_male = "3",
         black_female = "4",
         nat_amer_male = "5",
         nat_amer_female = "6",
         aapi_male = "7",
         aapi_female = "8") %>%
  mutate(tot_male = white_male + black_male + nat_amer_male + aapi_male,
         tot_pop = white_male + white_female + black_male + black_female +
           nat_amer_male + nat_amer_female + aapi_male + aapi_female) %>%
  group_by(state) %>%
  mutate(pct_male = sum(tot_male)/sum(tot_pop))
```

That gets the `pct_male` but I'm in a bit of a pickle with the race category. I think if I pull the origin column out, I should be able to add hispanic as its own category, though I need to do something pretty funky (pivoting longer to put the race/genders back into a col, then pulling out hispanics, then pulling out race based on the non-hispanic section).

```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  group_by(state, age_group, race_sex, origin) %>%
  mutate(pop = sum(pop)) %>%
  ungroup(state, age_group, race_sex, origin) %>%
  mutate(identity = paste(state, age_group, race_sex, origin, sep = "-")) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity) %>%
  pivot_wider(names_from = race_sex,
              values_from = pop) %>%
  rename(white_male = "1",
         white_female = "2",
         black_male = "3",
         black_female = "4",
         nat_amer_male = "5",
         nat_amer_female = "6",
         aapi_male = "7",
         aapi_female = "8") %>%
  mutate(tot_male = white_male + black_male + nat_amer_male + aapi_male,
         tot_pop = white_male + white_female + black_male + black_female +
           nat_amer_male + nat_amer_female + aapi_male + aapi_female) %>%
  group_by(state) %>%
  mutate(pct_male = sum(tot_male)/sum(tot_pop)) %>%
  ungroup() %>%
  select(-tot_male) %>%
  pivot_longer(cols = c("white_male", "white_female", "black_male", "black_female",
                        "nat_amer_male", "nat_amer_female", "aapi_male", "aapi_female"),
               names_to = "race_sex",
               values_to = "pop") %>%
  pivot_wider(names_from = origin,
              values_from = pop) %>%
  rename(non_hispanic = "1",
         hispanic = "2") %>%
  replace_na(list(hispanic = 0)) %>%
  pivot_wider(names_from = race_sex,
              values_from = non_hispanic)
```

This doesn't seem right - I'm getting `NA` for hispanics when any other race is filled in and `NA` for other races when hispanics is filled in... It shouldn't be mutually exclusive. 

Let me try starting with origin.

```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  group_by(state, age_group, race_sex, origin) %>%
  mutate(pop = sum(pop)) %>%
  ungroup(state, age_group, race_sex, origin) %>%
  mutate(identity = paste(state, age_group, race_sex, origin, sep = "-")) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity) %>%
  pivot_wider(names_from = race_sex,
              values_from = pop) %>%
  rename(white_male = "1",
         white_female = "2",
         black_male = "3",
         black_female = "4",
         nat_amer_male = "5",
         nat_amer_female = "6",
         aapi_male = "7",
         aapi_female = "8") %>%
  mutate(male = white_male + black_male + nat_amer_male + aapi_male,
         female = white_female + black_female + nat_amer_female + aapi_female,
         white = white_male + white_female,
         black = black_male + black_female,
         nat_amer = nat_amer_male + nat_amer_female,
         aapi = aapi_male + aapi_female) %>%
  select(-white_male, -black_male, -nat_amer_male, -aapi_male, 
         -white_female, -black_female, -nat_amer_female, -aapi_female) %>%
  mutate(check = male + female - white - black - nat_amer - aapi) %>%
  distinct(check)
```

That was a long way of checking that I had separated out the race/sexes. Now to get hispanic as a race...

```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  group_by(state, age_group, race_sex, origin) %>%
  mutate(pop = sum(pop)) %>%
  ungroup(state, age_group, race_sex, origin) %>%
  mutate(identity = paste(state, age_group, race_sex, origin, sep = "-")) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity) %>%
  pivot_wider(names_from = race_sex,
              values_from = pop) %>%
  rename(white_male = "1",
         white_female = "2",
         black_male = "3",
         black_female = "4",
         nat_amer_male = "5",
         nat_amer_female = "6",
         aapi_male = "7",
         aapi_female = "8") %>%
  mutate(male = white_male + black_male + nat_amer_male + aapi_male,
         female = white_female + black_female + nat_amer_female + aapi_female,
         white = white_male + white_female,
         black = black_male + black_female,
         nat_amer = nat_amer_male + nat_amer_female,
         aapi = aapi_male + aapi_female) %>%
  select(-white_male, -black_male, -nat_amer_male, -aapi_male, 
         -white_female, -black_female, -nat_amer_female, -aapi_female) %>%
  pivot_longer(cols = c("white", "black", "nat_amer", "aapi"),
               names_to = "race",
               values_to = "pop") %>%
  mutate(race = if_else(origin == 2, "hispanic", race)) %>%
  pivot_wider(names_from = race,
              values_from = pop)
```

Ah, that weird list issue again. I think I recall how to fix this, need to create a summarized group row. 

```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  group_by(state, age_group, race_sex, origin) %>%
  mutate(pop = sum(pop)) %>%
  ungroup(state, age_group, race_sex, origin) %>%
  mutate(identity = paste(state, age_group, race_sex, origin, sep = "-")) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity) %>%
  pivot_wider(names_from = race_sex,
              values_from = pop) %>%
  rename(white_male = "1",
         white_female = "2",
         black_male = "3",
         black_female = "4",
         nat_amer_male = "5",
         nat_amer_female = "6",
         aapi_male = "7",
         aapi_female = "8") %>%
  mutate(male = white_male + black_male + nat_amer_male + aapi_male,
         female = white_female + black_female + nat_amer_female + aapi_female,
         white = white_male + white_female,
         black = black_male + black_female,
         nat_amer = nat_amer_male + nat_amer_female,
         aapi = aapi_male + aapi_female) %>%
  select(-white_male, -black_male, -nat_amer_male, -aapi_male, 
         -white_female, -black_female, -nat_amer_female, -aapi_female) %>%
  pivot_longer(cols = c("white", "black", "nat_amer", "aapi"),
               names_to = "race",
               values_to = "pop") %>%
  mutate(race = if_else(origin == 2, "hispanic", race)) %>%
  select(-origin) %>%
  group_by(state, age_group, race) %>%
  mutate(tot_pop = sum(pop),
         identity = paste(state, age_group, race, sep = "-")) %>%
  ungroup(state, age_group, race) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity, -pop) %>%
  pivot_wider(names_from = race,
              values_from = tot_pop)
  
```

This is still giving me that weird `NA` error, but I think I've figured out why - I need to just calculate out the `pct_male` per state prior to digging into race, otherwise it'll create a new row variable for each unique male/female population (aka, it won't change row numbers). 

```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  group_by(state, age_group, race_sex, origin) %>%
  mutate(pop = sum(pop)) %>%
  ungroup(state, age_group, race_sex, origin) %>%
  mutate(identity = paste(state, age_group, race_sex, origin, sep = "-")) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity) %>%
  pivot_wider(names_from = race_sex,
              values_from = pop) %>%
  rename(white_male = "1",
         white_female = "2",
         black_male = "3",
         black_female = "4",
         nat_amer_male = "5",
         nat_amer_female = "6",
         aapi_male = "7",
         aapi_female = "8") %>%
  mutate(male = white_male + black_male + nat_amer_male + aapi_male,
         female = white_female + black_female + nat_amer_female + aapi_female,
         white = white_male + white_female,
         black = black_male + black_female,
         nat_amer = nat_amer_male + nat_amer_female,
         aapi = aapi_male + aapi_female) %>%
  select(-white_male, -black_male, -nat_amer_male, -aapi_male, 
         -white_female, -black_female, -nat_amer_female, -aapi_female) %>%
  group_by(state) %>%
  mutate(pct_male = sum(male)/(sum(male) + sum(female))) %>%
  select(-male, -female) %>%
  pivot_longer(cols = c("white", "black", "nat_amer", "aapi"),
               names_to = "race",
               values_to = "pop") %>%
  mutate(race = if_else(origin == 2, "hispanic", race)) %>%
  select(-origin) %>%
  group_by(state, age_group, race) %>%
  mutate(tot_pop = sum(pop),
         identity = paste(state, age_group, race, sep = "-")) %>%
  ungroup(state, age_group, race) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity, -pop) %>%
  pivot_wider(names_from = race,
              values_from = tot_pop)
```

That's seemed to *mostly* work, but I've just noticed that there are a whole bunch of `NA` states (this is an independent problem of the hispanic thing, I think it's a mismatch with the FIPS frame). Let's see if any states are missing. 

```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  group_by(state, age_group, race_sex, origin) %>%
  mutate(pop = sum(pop)) %>%
  ungroup(state, age_group, race_sex, origin) %>%
  mutate(identity = paste(state, age_group, race_sex, origin, sep = "-")) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity) %>%
  pivot_wider(names_from = race_sex,
              values_from = pop) %>%
  rename(white_male = "1",
         white_female = "2",
         black_male = "3",
         black_female = "4",
         nat_amer_male = "5",
         nat_amer_female = "6",
         aapi_male = "7",
         aapi_female = "8") %>%
  mutate(male = white_male + black_male + nat_amer_male + aapi_male,
         female = white_female + black_female + nat_amer_female + aapi_female,
         white = white_male + white_female,
         black = black_male + black_female,
         nat_amer = nat_amer_male + nat_amer_female,
         aapi = aapi_male + aapi_female) %>%
  select(-white_male, -black_male, -nat_amer_male, -aapi_male, 
         -white_female, -black_female, -nat_amer_female, -aapi_female) %>%
  group_by(state) %>%
  mutate(pct_male = sum(male)/(sum(male) + sum(female))) %>%
  select(-male, -female) %>%
  pivot_longer(cols = c("white", "black", "nat_amer", "aapi"),
               names_to = "race",
               values_to = "pop") %>%
  mutate(race = if_else(origin == 2, "hispanic", race)) %>%
  select(-origin) %>%
  group_by(state, age_group, race) %>%
  mutate(tot_pop = sum(pop),
         identity = paste(state, age_group, race, sep = "-")) %>%
  ungroup(state, age_group, race) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity, -pop) %>%
  pivot_wider(names_from = race,
              values_from = tot_pop) %>%
  distinct(state)
```

Huh. Strange. Every state is represented (as well as DC), there's just an extra `NA` - maybe this was used for US in the original dataset. Either way, I think I can safely remove this from the frame. 

```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  group_by(state, age_group, race_sex, origin) %>%
  mutate(pop = sum(pop)) %>%
  ungroup(state, age_group, race_sex, origin) %>%
  mutate(identity = paste(state, age_group, race_sex, origin, sep = "-")) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity) %>%
  pivot_wider(names_from = race_sex,
              values_from = pop) %>%
  rename(white_male = "1",
         white_female = "2",
         black_male = "3",
         black_female = "4",
         nat_amer_male = "5",
         nat_amer_female = "6",
         aapi_male = "7",
         aapi_female = "8") %>%
  mutate(male = white_male + black_male + nat_amer_male + aapi_male,
         female = white_female + black_female + nat_amer_female + aapi_female,
         white = white_male + white_female,
         black = black_male + black_female,
         nat_amer = nat_amer_male + nat_amer_female,
         aapi = aapi_male + aapi_female) %>%
  select(-white_male, -black_male, -nat_amer_male, -aapi_male, 
         -white_female, -black_female, -nat_amer_female, -aapi_female) %>%
  group_by(state) %>%
  mutate(pct_male = sum(male)/(sum(male) + sum(female))) %>%
  select(-male, -female) %>%
  pivot_longer(cols = c("white", "black", "nat_amer", "aapi"),
               names_to = "race",
               values_to = "pop") %>%
  mutate(race = if_else(origin == 2, "hispanic", race)) %>%
  select(-origin) %>%
  group_by(state, age_group, race) %>%
  mutate(tot_pop = sum(pop),
         identity = paste(state, age_group, race, sep = "-")) %>%
  ungroup(state, age_group, race) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity, -pop) %>%
  pivot_wider(names_from = race,
              values_from = tot_pop) %>%
  drop_na()
```

That get's me where I need to be, so now I can *finally* calculate the race percentages for each state.

```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  group_by(state, age_group, race_sex, origin) %>%
  mutate(pop = sum(pop)) %>%
  ungroup(state, age_group, race_sex, origin) %>%
  mutate(identity = paste(state, age_group, race_sex, origin, sep = "-")) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity) %>%
  pivot_wider(names_from = race_sex,
              values_from = pop) %>%
  rename(white_male = "1",
         white_female = "2",
         black_male = "3",
         black_female = "4",
         nat_amer_male = "5",
         nat_amer_female = "6",
         aapi_male = "7",
         aapi_female = "8") %>%
  mutate(male = white_male + black_male + nat_amer_male + aapi_male,
         female = white_female + black_female + nat_amer_female + aapi_female,
         white = white_male + white_female,
         black = black_male + black_female,
         nat_amer = nat_amer_male + nat_amer_female,
         aapi = aapi_male + aapi_female) %>%
  select(-white_male, -black_male, -nat_amer_male, -aapi_male, 
         -white_female, -black_female, -nat_amer_female, -aapi_female) %>%
  group_by(state) %>%
  mutate(pct_male = sum(male)/(sum(male) + sum(female))) %>%
  select(-male, -female) %>%
  pivot_longer(cols = c("white", "black", "nat_amer", "aapi"),
               names_to = "race",
               values_to = "pop") %>%
  mutate(race = if_else(origin == 2, "hispanic", race)) %>%
  select(-origin) %>%
  group_by(state, age_group, race) %>%
  mutate(tot_pop = sum(pop),
         identity = paste(state, age_group, race, sep = "-")) %>%
  ungroup(state, age_group, race) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity, -pop) %>%
  pivot_wider(names_from = race,
              values_from = tot_pop) %>%
  drop_na() %>%
  mutate(tot_row = white + black + nat_amer + aapi + hispanic) %>%
  group_by(state) %>%
  mutate(pct_white = sum(white)/sum(tot_row),
         pct_black = sum(black)/sum(tot_row),
         pct_nat_american = sum(nat_amer)/sum(tot_row),
         pct_hispanic = sum(hispanic)/sum(tot_row),
         pct_aapi = sum(aapi)/sum(tot_row)) %>%
  ungroup() %>%
  mutate(check = pct_white + pct_black + pct_nat_american + pct_hispanic + pct_aapi) %>%
  distinct(check)
```

I'm not quite sure why I got 3 rows, but since they're all 1, I think this check is okay (perhaps it's a rounding issue where one is off by 0.0000000...1 in one direction and another is off by 0.0000000...1 in another). Not going to worry about it too much - now I can clean this up. 

```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  group_by(state, age_group, race_sex, origin) %>%
  mutate(pop = sum(pop)) %>%
  ungroup(state, age_group, race_sex, origin) %>%
  mutate(identity = paste(state, age_group, race_sex, origin, sep = "-")) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity) %>%
  pivot_wider(names_from = race_sex,
              values_from = pop) %>%
  rename(white_male = "1",
         white_female = "2",
         black_male = "3",
         black_female = "4",
         nat_amer_male = "5",
         nat_amer_female = "6",
         aapi_male = "7",
         aapi_female = "8") %>%
  mutate(male = white_male + black_male + nat_amer_male + aapi_male,
         female = white_female + black_female + nat_amer_female + aapi_female,
         white = white_male + white_female,
         black = black_male + black_female,
         nat_amer = nat_amer_male + nat_amer_female,
         aapi = aapi_male + aapi_female) %>%
  select(-white_male, -black_male, -nat_amer_male, -aapi_male, 
         -white_female, -black_female, -nat_amer_female, -aapi_female) %>%
  group_by(state) %>%
  mutate(pct_male = sum(male)/(sum(male) + sum(female))) %>%
  select(-male, -female) %>%
  pivot_longer(cols = c("white", "black", "nat_amer", "aapi"),
               names_to = "race",
               values_to = "pop") %>%
  mutate(race = if_else(origin == 2, "hispanic", race)) %>%
  select(-origin) %>%
  group_by(state, age_group, race) %>%
  mutate(tot_pop = sum(pop),
         identity = paste(state, age_group, race, sep = "-")) %>%
  ungroup(state, age_group, race) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity, -pop) %>%
  pivot_wider(names_from = race,
              values_from = tot_pop) %>%
  drop_na() %>%
  mutate(tot_row = white + black + nat_amer + aapi + hispanic) %>%
  group_by(state) %>%
  mutate(pct_white = sum(white)/sum(tot_row),
         pct_black = sum(black)/sum(tot_row),
         pct_nat_american = sum(nat_amer)/sum(tot_row),
         pct_hispanic = sum(hispanic)/sum(tot_row),
         pct_aapi = sum(aapi)/sum(tot_row)) %>%
  ungroup() %>%
  select(-white, -black, -nat_amer, -aapi, -hispanic)
```

The 90s datasets break up age into age group codes:
* **0 :** < 1 year;
* **1 :** 1 - 4 years;
* **2 :** 5 - 9 years;
* **3 :** 10 - 14 years;
* **4 :** 15 - 19 years;
* **5 :** 20 - 24 years;
* **6 :** 25 - 29 years;
* **7 :** 30 - 34 years;
* **8 :** 35 - 39 years;
* **9 :** 40 - 44 years;
* **10 :** 45 - 49 years;
* **11 :** 50 - 54 years;
* **12 :** 55 - 59 years;
* **13 :** 60 - 64 years;
* **14 :** 65 - 69 years;
* **15 :** 70 - 74 years;
* **16 :** 75 - 79 years;
* **17 :** 80 - 84 years;
* **18 :** 85 years and older.

For calculating the mean age, I'll assume that the ages are evenly distributed throughout the age range, and just use the mean of each group in the age score calc. For the over-18 avg age, this same logic would mean that 40% of total population for that category 4 (15 - 19 years) would be included (i.e., 18/19 are two of the five ages in this category), with an average age of 18.5. 

To avoid a whole mess of nested `if_else` statements, I'll just throw together a quick frame for the age groups. 

```{r}
f_agegroups <- tibble(group = seq(0, 18, 1),
                      mean_age = c(0, seq(2.5, 82.5, 5), 85))

f_agegroups
```

Awesome, now I can `left_join` this and calculate the mean age for each state. 


```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  group_by(state, age_group, race_sex, origin) %>%
  mutate(pop = sum(pop)) %>%
  ungroup(state, age_group, race_sex, origin) %>%
  mutate(identity = paste(state, age_group, race_sex, origin, sep = "-")) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity) %>%
  pivot_wider(names_from = race_sex,
              values_from = pop) %>%
  rename(white_male = "1",
         white_female = "2",
         black_male = "3",
         black_female = "4",
         nat_amer_male = "5",
         nat_amer_female = "6",
         aapi_male = "7",
         aapi_female = "8") %>%
  mutate(male = white_male + black_male + nat_amer_male + aapi_male,
         female = white_female + black_female + nat_amer_female + aapi_female,
         white = white_male + white_female,
         black = black_male + black_female,
         nat_amer = nat_amer_male + nat_amer_female,
         aapi = aapi_male + aapi_female) %>%
  select(-white_male, -black_male, -nat_amer_male, -aapi_male, 
         -white_female, -black_female, -nat_amer_female, -aapi_female) %>%
  group_by(state) %>%
  mutate(pct_male = sum(male)/(sum(male) + sum(female))) %>%
  select(-male, -female) %>%
  pivot_longer(cols = c("white", "black", "nat_amer", "aapi"),
               names_to = "race",
               values_to = "pop") %>%
  mutate(race = if_else(origin == 2, "hispanic", race)) %>%
  select(-origin) %>%
  group_by(state, age_group, race) %>%
  mutate(tot_pop = sum(pop),
         identity = paste(state, age_group, race, sep = "-")) %>%
  ungroup(state, age_group, race) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity, -pop) %>%
  pivot_wider(names_from = race,
              values_from = tot_pop) %>%
  drop_na() %>%
  mutate(tot_row = white + black + nat_amer + aapi + hispanic) %>%
  group_by(state) %>%
  mutate(pct_white = sum(white)/sum(tot_row),
         pct_black = sum(black)/sum(tot_row),
         pct_nat_american = sum(nat_amer)/sum(tot_row),
         pct_hispanic = sum(hispanic)/sum(tot_row),
         pct_aapi = sum(aapi)/sum(tot_row)) %>%
  ungroup() %>%
  select(-white, -black, -nat_amer, -aapi, -hispanic) %>%
  left_join(f_agegroups, by = c("age_group" = "group")) %>%
  relocate(mean_age, .after = age_group) %>%
  mutate(age_score = mean_age * tot_row,
         age_score_adult = if_else(age_group < 4,
                                   0,
                                   if_else(age_group == 4, 
                                           0.4 * 19 * tot_row,
                                           mean_age * tot_row)),
         tot_adult = if_else(age_group < 4, 
                             0,
                             if_else(age_group == 4,
                                     0.4 * tot_row,
                                     tot_row))) %>%
  group_by(state) %>%
  mutate(avg_age = sum(age_score)/sum(tot_row),
         avg_age_adult = sum(age_score_adult)/sum(tot_adult)) %>%
  ungroup() %>%
  select(-age_score, -age_score_adult, -tot_adult)
```

Coolio bo-boolio. Now I can move on to getting the age categories (0 - 17, 18 - 34, 35 - 64, 65+).

```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  group_by(state, age_group, race_sex, origin) %>%
  mutate(pop = sum(pop)) %>%
  ungroup(state, age_group, race_sex, origin) %>%
  mutate(identity = paste(state, age_group, race_sex, origin, sep = "-")) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity) %>%
  pivot_wider(names_from = race_sex,
              values_from = pop) %>%
  rename(white_male = "1",
         white_female = "2",
         black_male = "3",
         black_female = "4",
         nat_amer_male = "5",
         nat_amer_female = "6",
         aapi_male = "7",
         aapi_female = "8") %>%
  mutate(male = white_male + black_male + nat_amer_male + aapi_male,
         female = white_female + black_female + nat_amer_female + aapi_female,
         white = white_male + white_female,
         black = black_male + black_female,
         nat_amer = nat_amer_male + nat_amer_female,
         aapi = aapi_male + aapi_female) %>%
  select(-white_male, -black_male, -nat_amer_male, -aapi_male, 
         -white_female, -black_female, -nat_amer_female, -aapi_female) %>%
  group_by(state) %>%
  mutate(pct_male = sum(male)/(sum(male) + sum(female))) %>%
  select(-male, -female) %>%
  pivot_longer(cols = c("white", "black", "nat_amer", "aapi"),
               names_to = "race",
               values_to = "pop") %>%
  mutate(race = if_else(origin == 2, "hispanic", race)) %>%
  select(-origin) %>%
  group_by(state, age_group, race) %>%
  mutate(tot_pop = sum(pop),
         identity = paste(state, age_group, race, sep = "-")) %>%
  ungroup(state, age_group, race) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity, -pop) %>%
  pivot_wider(names_from = race,
              values_from = tot_pop) %>%
  drop_na() %>%
  mutate(tot_row = white + black + nat_amer + aapi + hispanic) %>%
  group_by(state) %>%
  mutate(pct_white = sum(white)/sum(tot_row),
         pct_black = sum(black)/sum(tot_row),
         pct_nat_american = sum(nat_amer)/sum(tot_row),
         pct_hispanic = sum(hispanic)/sum(tot_row),
         pct_aapi = sum(aapi)/sum(tot_row)) %>%
  ungroup() %>%
  select(-white, -black, -nat_amer, -aapi, -hispanic) %>%
  left_join(f_agegroups, by = c("age_group" = "group")) %>%
  relocate(mean_age, .after = age_group) %>%
  mutate(age_score = mean_age * tot_row,
         age_score_adult = if_else(age_group < 4,
                                   0,
                                   if_else(age_group == 4, 
                                           0.4 * 19 * tot_row,
                                           mean_age * tot_row)),
         tot_adult = if_else(age_group < 4, 
                             0,
                             if_else(age_group == 4,
                                     0.4 * tot_row,
                                     tot_row))) %>%
  group_by(state) %>%
  mutate(avg_age = sum(age_score)/sum(tot_row),
         avg_age_adult = sum(age_score_adult)/sum(tot_adult)) %>%
  ungroup() %>%
  select(-age_score, -age_score_adult, -tot_adult) %>%
  mutate(age_00_17 = if_else(age_group < 4,
                             tot_row,
                             if_else(age_group == 4,
                                     tot_row * 0.6,
                                     0)),
         age_18_34 = if_else(age_group < 4, 
                             0,
                             if_else(age_group == 4,
                                     tot_row * 0.4,
                                     if_else(age_group <= 7,
                                             tot_row,
                                             0))),
         age_35_64 = if_else(age_group < 8,
                             0,
                             if_else(age_group > 13,
                                     0,
                                     tot_row)),
         age_65_00 = if_else(age_group < 14,
                             0,
                             tot_row)) %>%
  group_by(state) %>%
  mutate(pct_00_17 = sum(age_00_17)/sum(tot_row),
         pct_18_34 = sum(age_18_34)/sum(tot_row),
         pct_35_64 = sum(age_35_64)/sum(tot_row),
         pct_65_00 = sum(age_65_00)/sum(tot_row),
         population = sum(tot_row)) %>%
  select(-age_00_17, -age_18_34, -age_35_64, -age_65_00, -age_group, -mean_age, -tot_row) %>%
  distinct(state, .keep_all = TRUE)
```

And... I think that's it. Well, just need to do some formatting so that I can merge this with the 2000s+ dataframe later. I'll reformate the upper section to match state instead of name (don't know why I didn't do that beforehand). I'll make a quick frame of the state abbreviations and their names (I dragged & dropped stuff from [here]())

```{r}
f_states <- read_csv("C:/Users/z003ynch/Desktop/Personal/site_projects/thedatadiary_repo/electionsimulator/data/raw/states.csv")

f_states
```

This one's missing DC, so I'll add that manually. 

```{r}
f_states <- f_states %>%
  add_row(`US STATE` = "District of Columbia",
          ABBREVIATION = "DC") %>%
  rename(us_state = `US STATE`,
         abbreviation = ABBREVIATION)

f_states
```

Now to join this up & format the whole shebang to be mergeable. 

```{r}
f_cb1990 %>%
  left_join(f_fips, by = c("state-county_FIPS" = "FIPS")) %>%
  select(-`state-county_FIPS`, -Name) %>%
  relocate(State, .after = year) %>%
  rename(state = State,
         race_sex = `race-sex`) %>%
  mutate(year = as.character(year)) %>%
  group_by(state, age_group, race_sex, origin) %>%
  mutate(pop = sum(pop)) %>%
  ungroup(state, age_group, race_sex, origin) %>%
  mutate(identity = paste(state, age_group, race_sex, origin, sep = "-")) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity) %>%
  pivot_wider(names_from = race_sex,
              values_from = pop) %>%
  rename(white_male = "1",
         white_female = "2",
         black_male = "3",
         black_female = "4",
         nat_amer_male = "5",
         nat_amer_female = "6",
         aapi_male = "7",
         aapi_female = "8") %>%
  mutate(male = white_male + black_male + nat_amer_male + aapi_male,
         female = white_female + black_female + nat_amer_female + aapi_female,
         white = white_male + white_female,
         black = black_male + black_female,
         nat_amer = nat_amer_male + nat_amer_female,
         aapi = aapi_male + aapi_female) %>%
  select(-white_male, -black_male, -nat_amer_male, -aapi_male, 
         -white_female, -black_female, -nat_amer_female, -aapi_female) %>%
  group_by(state) %>%
  mutate(pct_male = sum(male)/(sum(male) + sum(female))) %>%
  select(-male, -female) %>%
  pivot_longer(cols = c("white", "black", "nat_amer", "aapi"),
               names_to = "race",
               values_to = "pop") %>%
  mutate(race = if_else(origin == 2, "hispanic", race)) %>%
  select(-origin) %>%
  group_by(state, age_group, race) %>%
  mutate(tot_pop = sum(pop),
         identity = paste(state, age_group, race, sep = "-")) %>%
  ungroup(state, age_group, race) %>%
  distinct(identity, .keep_all = TRUE) %>%
  select(-identity, -pop) %>%
  pivot_wider(names_from = race,
              values_from = tot_pop) %>%
  drop_na() %>%
  mutate(tot_row = white + black + nat_amer + aapi + hispanic) %>%
  group_by(state) %>%
  mutate(pct_white = sum(white)/sum(tot_row),
         pct_black = sum(black)/sum(tot_row),
         pct_nat_american = sum(nat_amer)/sum(tot_row),
         pct_hispanic = sum(hispanic)/sum(tot_row),
         pct_aapi = sum(aapi)/sum(tot_row)) %>%
  ungroup() %>%
  select(-white, -black, -nat_amer, -aapi, -hispanic) %>%
  left_join(f_agegroups, by = c("age_group" = "group")) %>%
  relocate(mean_age, .after = age_group) %>%
  mutate(age_score = mean_age * tot_row,
         age_score_adult = if_else(age_group < 4,
                                   0,
                                   if_else(age_group == 4, 
                                           0.4 * 19 * tot_row,
                                           mean_age * tot_row)),
         tot_adult = if_else(age_group < 4, 
                             0,
                             if_else(age_group == 4,
                                     0.4 * tot_row,
                                     tot_row))) %>%
  group_by(state) %>%
  mutate(avg_age = sum(age_score)/sum(tot_row),
         avg_age_adult = sum(age_score_adult)/sum(tot_adult)) %>%
  ungroup() %>%
  select(-age_score, -age_score_adult, -tot_adult) %>%
  mutate(age_00_17 = if_else(age_group < 4,
                             tot_row,
                             if_else(age_group == 4,
                                     tot_row * 0.6,
                                     0)),
         age_18_34 = if_else(age_group < 4, 
                             0,
                             if_else(age_group == 4,
                                     tot_row * 0.4,
                                     if_else(age_group <= 7,
                                             tot_row,
                                             0))),
         age_35_64 = if_else(age_group < 8,
                             0,
                             if_else(age_group > 13,
                                     0,
                                     tot_row)),
         age_65_00 = if_else(age_group < 14,
                             0,
                             tot_row)) %>%
  group_by(state) %>%
  mutate(pct_00_17 = sum(age_00_17)/sum(tot_row),
         pct_18_34 = sum(age_18_34)/sum(tot_row),
         pct_35_64 = sum(age_35_64)/sum(tot_row),
         pct_65_00 = sum(age_65_00)/sum(tot_row),
         pop = sum(tot_row)) %>%
  ungroup() %>%
  select(-age_00_17, -age_18_34, -age_35_64, -age_65_00, -age_group, -mean_age, -tot_row) %>%
  distinct(state, .keep_all = TRUE) %>%
  mutate(year = paste("19", year, sep = "")) %>%
  left_join(f_states, by = c("state" = "abbreviation")) %>%
  mutate(state = us_state) %>%
  select(-us_state) %>%
  relocate(state) %>%
  relocate(pop, .after = year)
```

Awesome. That's a good stopping point for today. Getting a 954,864 x 6 frame to a 51 x 15 frame is wyld. I'll render this for upload to github & call it a day today. Tomorrow I'll try to get a function written to do this for the other datatables for the 90s that comes from the census bureau. 















































